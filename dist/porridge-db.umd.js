!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WebPorridgeDB={})}(this,(function(e){"use strict";const t=e=>{const t=typeof e;return null!==e&&("object"===t||"function"===t)},n=new Set(["__proto__","prototype","constructor"]),r=new Set("0123456789");function i(e){const t=[];let i="",a="start",o=!1;for(const s of e)switch(s){case"\\":if("index"===a)throw new Error("Invalid character in an index");if("indexEnd"===a)throw new Error("Invalid character after an index");o&&(i+=s),a="property",o=!o;break;case".":if("index"===a)throw new Error("Invalid character in an index");if("indexEnd"===a){a="property";break}if(o){o=!1,i+=s;break}if(n.has(i))return[];t.push(i),i="",a="property";break;case"[":if("index"===a)throw new Error("Invalid character in an index");if("indexEnd"===a){a="index";break}if(o){o=!1,i+=s;break}if("property"===a){if(n.has(i))return[];t.push(i),i=""}a="index";break;case"]":if("index"===a){t.push(Number.parseInt(i,10)),i="",a="indexEnd";break}if("indexEnd"===a)throw new Error("Invalid character after an index");default:if("index"===a&&!r.has(s))throw new Error("Invalid character in an index");if("indexEnd"===a)throw new Error("Invalid character after an index");"start"===a&&(a="property"),o&&(o=!1,i+="\\"),i+=s}switch(o&&(i+="\\"),a){case"property":if(n.has(i))return[];t.push(i);break;case"index":throw new Error("Index was not closed");case"start":t.push("")}return t}function a(e,t){if("number"!=typeof t&&Array.isArray(e)){const n=Number.parseInt(t,10);return Number.isInteger(n)&&e[n]===e[t]}return!1}function o(e,t){if(a(e,t))throw new Error("Cannot use string index")}function s(e){return new Promise(((t,n)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>n(e.error)}))}function c(e,t){const n=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(e){var t=function(){return indexedDB.databases().finally(e)};r=setInterval(t,100),t()})).finally((function(){return clearInterval(r)})):Promise.resolve()).then((()=>{const n=indexedDB.open(e);return n.onupgradeneeded=()=>n.result.createObjectStore(t),s(n)}));var r;return(e,r)=>n.then((n=>r(n.transaction(t,e).objectStore(t))))}let u;function d(){return u||(u=c("keyval-store","keyval")),u}function l(e=d()){return e("readonly",(e=>{if(e.getAllKeys)return s(e.getAllKeys());const t=[];return function(e,t){return e.openCursor().onsuccess=function(){this.result&&(t(this.result),this.result.continue())},s(e.transaction)}(e,(e=>t.push(e.key))).then((()=>t))}))}const f="@value",h="@type",w="@expires";function y(e){switch(Object.prototype.toString.call(e)){case"[object Array]":case"[object Object]":return"object";case"[object BigInt]":return"bigint";case"[object Boolean]":return"boolean";case"[object Null]":return"null";case"[object Number]":return"number";case"[object String]":return"string";case"[object Undefined]":return"undefined"}}function p(e,t){try{window.dispatchEvent(new CustomEvent(e,{detail:t}))}catch(e){}}/*! web-porridge | MIT License | https://github.com/idleberg/web-porridge */
const b="web-porridge:db.didChange";e.WebPorridgeDB=class{store;constructor(e){if("undefined"!=typeof window&&!("indexedDB"in window))throw Error("Your browser does not support IndexedDB");const{db:t,name:n}={db:"WebPorridge",name:"(default store)",...e};this.store=c(t,n)}async setItem(e,n,r={}){if(r?.key?.length){const a=await this.getItem(e)||{};return function(e,n,r){if(!t(e)||"string"!=typeof n)return e;const a=e,s=i(n);for(let n=0;n<s.length;n++){const i=s[n];o(e,i),n===s.length-1?e[i]=r:t(e[i])||(e[i]="number"==typeof s[n+1]?[]:{}),e=e[i]}}(a,r.key,n),await this.setItem(e,a,{...r,key:void 0})}const a={[f]:(c=n,"bigint"==typeof c?c.toString():c),[h]:y(n)};var c;return r?.expires&&String(r.expires).length&&(a[w]=new Date(r.expires)),p(b,{key:e,value:n}),await function(e,t,n=d()){return n("readwrite",(n=>(n.put(t,e),s(n.transaction))))}(e,a,this.store)}async getItem(e,n){const r=await function(e,t=d()){return t("readonly",(t=>s(t.get(e))))}(e,this.store);if(!r||(o=r[w])&&new Date(o)<=new Date)return null;var o;const c=function(e){const t=e[f];switch(e[h]){case"boolean":case"null":case"number":case"object":case"undefined":return t;case"bigint":return BigInt(t);case"string":return t.toString();default:return e}}(r);return"object"===r[h]&&n?.key?.length?function(e,n,r){if(!t(e)||"string"!=typeof n)return void 0===r?e:r;const o=i(n);if(0===o.length)return r;for(let t=0;t<o.length;t++){const n=o[t];if(null==(e=a(e,n)?t===o.length-1?void 0:null:e[n])){if(t!==o.length-1)return r;break}}return void 0===e?r:e}(c,n.key):c}async removeItem(e,n=""){if(n?.length){const r=await this.getItem(e)||{};return function(e,n){if(!t(e)||"string"!=typeof n)return!1;const r=i(n);for(let n=0;n<r.length;n++){const i=r[n];if(o(e,i),n===r.length-1)return delete e[i],!0;if(e=e[i],!t(e))return!1}}(r,n),await this.setItem(e,r)}return p(b,{key:e,value:null}),await function(e,t=d()){return t("readwrite",(t=>(t.delete(e),s(t.transaction))))}(e,this.store)}async key(e){return(await l(this.store))[e]}get length(){return(async()=>(await l(this.store)).length)()}async clear(){return p(b,{value:null}),await function(e=d()){return e("readwrite",(e=>(e.clear(),s(e.transaction))))}(this.store)}async hasItem(e){return(await l(this.store)).includes(e)}async keys(){return await l(this.store)}async values(){return Promise.all((await l(this.store)).map((async e=>await this.getItem(e))))}async entries(){return Promise.all((await l(this.store)).map((async e=>[e,await this.getItem(e)])))}observe(e,t){!function(e,t,n){window.addEventListener(e,(e=>{e.detail.key!==t&&void 0!==e.detail.key||n({key:t,value:e.detail.value})}))}(b,e,t)}},Object.defineProperty(e,"__esModule",{value:!0})}));//# sourceMappingURL=porridge-db.umd.js.map
