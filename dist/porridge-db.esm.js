const e=e=>{const t=typeof e;return null!==e&&("object"===t||"function"===t)},t=new Set(["__proto__","prototype","constructor"]),n=new Set("0123456789");function r(e){const r=[];let i="",a="start",o=!1;for(const s of e)switch(s){case"\\":if("index"===a)throw new Error("Invalid character in an index");if("indexEnd"===a)throw new Error("Invalid character after an index");o&&(i+=s),a="property",o=!o;break;case".":if("index"===a)throw new Error("Invalid character in an index");if("indexEnd"===a){a="property";break}if(o){o=!1,i+=s;break}if(t.has(i))return[];r.push(i),i="",a="property";break;case"[":if("index"===a)throw new Error("Invalid character in an index");if("indexEnd"===a){a="index";break}if(o){o=!1,i+=s;break}if("property"===a){if(t.has(i))return[];r.push(i),i=""}a="index";break;case"]":if("index"===a){r.push(Number.parseInt(i,10)),i="",a="indexEnd";break}if("indexEnd"===a)throw new Error("Invalid character after an index");default:if("index"===a&&!n.has(s))throw new Error("Invalid character in an index");if("indexEnd"===a)throw new Error("Invalid character after an index");"start"===a&&(a="property"),o&&(o=!1,i+="\\"),i+=s}switch(o&&(i+="\\"),a){case"property":if(t.has(i))return[];r.push(i);break;case"index":throw new Error("Index was not closed");case"start":r.push("")}return r}function i(e,t){if("number"!=typeof t&&Array.isArray(e)){const n=Number.parseInt(t,10);return Number.isInteger(n)&&e[n]===e[t]}return!1}function a(e,t){if(i(e,t))throw new Error("Cannot use string index")}function o(e){return new Promise(((t,n)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>n(e.error)}))}function s(e,t){const n=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(e){var t=function(){return indexedDB.databases().finally(e)};r=setInterval(t,100),t()})).finally((function(){return clearInterval(r)})):Promise.resolve()).then((()=>{const n=indexedDB.open(e);return n.onupgradeneeded=()=>n.result.createObjectStore(t),o(n)}));var r;return(e,r)=>n.then((n=>r(n.transaction(t,e).objectStore(t))))}let c;function u(){return c||(c=s("keyval-store","keyval")),c}function l(e=u()){return e("readonly",(e=>{if(e.getAllKeys)return o(e.getAllKeys());const t=[];return function(e,t){return e.openCursor().onsuccess=function(){this.result&&(t(this.result),this.result.continue())},o(e.transaction)}(e,(e=>t.push(e.key))).then((()=>t))}))}const d="@value",f="@type",h="@expires";function w(e){switch(Object.prototype.toString.call(e)){case"[object Array]":case"[object Object]":return"object";case"[object BigInt]":return"bigint";case"[object Boolean]":return"boolean";case"[object Null]":return"null";case"[object Number]":return"number";case"[object String]":return"string";case"[object Undefined]":return"undefined"}}function y(e,t){try{window.dispatchEvent(new CustomEvent(e,{detail:t}))}catch(e){}}/*! web-porridge | MIT License | https://github.com/idleberg/web-porridge */
const g="web-porridge:db.didChange";class p{store;constructor(e){if("undefined"!=typeof window&&!("indexedDB"in window))throw Error("Your browser does not support IndexedDB");const{db:t,name:n}={db:"WebPorridge",name:"(default store)",...e};this.store=s(t,n)}async setItem(t,n,i={}){if(i?.key?.length){const o=await this.getItem(t)||{};return function(t,n,i){if(!e(t)||"string"!=typeof n)return t;const o=t,s=r(n);for(let n=0;n<s.length;n++){const r=s[n];a(t,r),n===s.length-1?t[r]=i:e(t[r])||(t[r]="number"==typeof s[n+1]?[]:{}),t=t[r]}}(o,i.key,n),await this.setItem(t,o,{...i,key:void 0})}const s={[d]:(c=n,"bigint"==typeof c?c.toString():c),[f]:w(n)};var c;return i?.expires&&String(i.expires).length&&(s[h]=new Date(i.expires)),y(g,{key:t,value:n}),await function(e,t,n=u()){return n("readwrite",(n=>(n.put(t,e),o(n.transaction))))}(t,s,this.store)}async getItem(t,n){const a=await function(e,t=u()){return t("readonly",(t=>o(t.get(e))))}(t,this.store);if(!a||(s=a[h])&&new Date(s)<=new Date)return null;var s;const c=function(e){const t=e[d];switch(e[f]){case"boolean":case"null":case"number":case"object":case"undefined":return t;case"bigint":return BigInt(t);case"string":return t.toString();default:return e}}(a);return"object"===a[f]&&n?.key?.length?function(t,n,a){if(!e(t)||"string"!=typeof n)return void 0===a?t:a;const o=r(n);if(0===o.length)return a;for(let e=0;e<o.length;e++){const n=o[e];if(null==(t=i(t,n)?e===o.length-1?void 0:null:t[n])){if(e!==o.length-1)return a;break}}return void 0===t?a:t}(c,n.key):c}async removeItem(t,n=""){if(n?.length){const i=await this.getItem(t)||{};return function(t,n){if(!e(t)||"string"!=typeof n)return!1;const i=r(n);for(let n=0;n<i.length;n++){const r=i[n];if(a(t,r),n===i.length-1)return delete t[r],!0;if(t=t[r],!e(t))return!1}}(i,n),await this.setItem(t,i)}return y(g,{key:t,value:null}),await function(e,t=u()){return t("readwrite",(t=>(t.delete(e),o(t.transaction))))}(t,this.store)}async key(e){return(await l(this.store))[e]}get length(){return(async()=>(await l(this.store)).length)()}async clear(){return y(g,{value:null}),await function(e=u()){return e("readwrite",(e=>(e.clear(),o(e.transaction))))}(this.store)}async hasItem(e){return(await l(this.store)).includes(e)}async keys(){return await l(this.store)}async values(){return Promise.all((await l(this.store)).map((async e=>await this.getItem(e))))}async entries(){return Promise.all((await l(this.store)).map((async e=>[e,await this.getItem(e)])))}observe(e,t){!function(e,t,n){window.addEventListener(e,(e=>{e.detail.key!==t&&void 0!==e.detail.key||n({key:t,value:e.detail.value})}))}(g,e,t)}}export{p as WebPorridgeDB};//# sourceMappingURL=porridge-db.esm.js.map
