!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WebPorridge={})}(this,(function(e){"use strict";const t=e=>{const t=typeof e;return null!==e&&("object"===t||"function"===t)},r=new Set(["__proto__","prototype","constructor"]),n=new Set("0123456789");function i(e){const t=[];let i="",o="start",s=!1;for(const a of e)switch(a){case"\\":if("index"===o)throw new Error("Invalid character in an index");if("indexEnd"===o)throw new Error("Invalid character after an index");s&&(i+=a),o="property",s=!s;break;case".":if("index"===o)throw new Error("Invalid character in an index");if("indexEnd"===o){o="property";break}if(s){s=!1,i+=a;break}if(r.has(i))return[];t.push(i),i="",o="property";break;case"[":if("index"===o)throw new Error("Invalid character in an index");if("indexEnd"===o){o="index";break}if(s){s=!1,i+=a;break}if("property"===o){if(r.has(i))return[];t.push(i),i=""}o="index";break;case"]":if("index"===o){t.push(Number.parseInt(i,10)),i="",o="indexEnd";break}if("indexEnd"===o)throw new Error("Invalid character after an index");default:if("index"===o&&!n.has(a))throw new Error("Invalid character in an index");if("indexEnd"===o)throw new Error("Invalid character after an index");"start"===o&&(o="property"),s&&(s=!1,i+="\\"),i+=a}switch(s&&(i+="\\"),o){case"property":if(r.has(i))return[];t.push(i);break;case"index":throw new Error("Index was not closed");case"start":t.push("")}return t}function o(e,t){if("number"!=typeof t&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function s(e,t){if(o(e,t))throw new Error("Cannot use string index")}function a(e,r,n){if(!t(e)||"string"!=typeof r)return void 0===n?e:n;const s=i(r);if(0===s.length)return n;for(let t=0;t<s.length;t++){const r=s[t];if(null==(e=o(e,r)?t===s.length-1?void 0:null:e[r])){if(t!==s.length-1)return n;break}}return void 0===e?n:e}function c(e,r,n){if(!t(e)||"string"!=typeof r)return e;const o=e,a=i(r);for(let r=0;r<a.length;r++){const i=a[r];s(e,i),r===a.length-1?e[i]=n:t(e[i])||(e[i]="number"==typeof a[r+1]?[]:{}),e=e[i]}return o}function u(e,r){if(!t(e)||"string"!=typeof r)return!1;const n=i(r);for(let r=0;r<n.length;r++){const i=n[r];if(s(e,i),r===n.length-1)return delete e[i],!0;if(e=e[i],!t(e))return!1}}const l="@value",f="@type",d="@expires";function h(e){return"bigint"==typeof e?e.toString():e}function g(e){const t=e[l];switch(e[f]){case"string":return t.toString();case"bigint":return BigInt(t);default:return t}}function p(e){switch(Object.prototype.toString.call(e)){case"[object Array]":case"[object Object]":return"object";case"[object BigInt]":return"bigint";case"[object Boolean]":return"boolean";case"[objectNull]":return"null";case"[object Number]":return"number";case"[object String]":return"string";case"[object Undefined]":return"undefined"}}function y(e){return e&&new Date(e)<=new Date}const b=["localStorage","sessionStorage"];function w(e){return new Promise(((t,r)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>r(e.error)}))}function x(e,t){const r=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(e){var t=function(){return indexedDB.databases().finally(e)};n=setInterval(t,100),t()})).finally((function(){return clearInterval(n)})):Promise.resolve()).then((()=>{const r=indexedDB.open(e);return r.onupgradeneeded=()=>r.result.createObjectStore(t),w(r)}));var n;return(e,n)=>r.then((r=>n(r.transaction(t,e).objectStore(t))))}let m;function I(){return m||(m=x("keyval-store","keyval")),m}function v(e=I()){return e("readonly",(e=>{if(e.getAllKeys)return w(e.getAllKeys());const t=[];return function(e,t){return e.openCursor().onsuccess=function(){this.result&&(t(this.result),this.result.continue())},w(e.transaction)}(e,(e=>t.push(e.key))).then((()=>t))}))}e.WebPorridge=class{type;constructor(e="localStorage"){if("undefined"!=typeof window&&!(e in window))throw Error(`Your browser does not support ${e}`);if(!b.includes(e))throw`Invalid storage type specified, try ${b.join("|")} instead`;this.type=e}setItem(e,t,r){if(r?.key?.length){const n=this.getItem(e)||{};return c(n,r.key,t),this.setItem(e,n,{...r,key:void 0})}const n={[l]:h(t),[f]:p(t)};return r?.expires&&String(r.expires).length&&(n[d]=new Date(r.expires)),globalThis[this.type].setItem(e,JSON.stringify(n))}getItem(e,t){const r=JSON.parse(globalThis[this.type].getItem(e));if(!r||y(r[d]))return null;const n=g(r);return"object"===r[f]&&t?.key?.length?a(n,t.key):n}removeItem(e,t=""){if(t?.length){const r=this.getItem(e)||{};return u(r,t),this.setItem(e,r)}return globalThis[this.type].removeItem(e)}key(e){return globalThis[this.type].key(e)}get length(){return globalThis[this.type].length}clear(){return globalThis[this.type].clear()}},e.WebPorridgeDB=class{store;constructor(e){if("undefined"!=typeof window&&!("indexedDB"in window))throw Error("Your browser does not support IndexedDB");const{db:t,name:r}={db:"WebPorridge",name:"(default store)",...e};this.store=x(t,r)}async setItem(e,t,r={}){if(r?.key?.length){const n=await this.getItem(e)||{};return c(n,r.key,t),await this.setItem(e,n,{...r,key:void 0})}const n={[l]:h(t),[f]:p(t)};return r?.expires&&String(r.expires).length&&(n[d]=new Date(r.expires)),await function(e,t,r=I()){return r("readwrite",(r=>(r.put(t,e),w(r.transaction))))}(e,n,this.store)}async getItem(e,t){const r=await function(e,t=I()){return t("readonly",(t=>w(t.get(e))))}(e,this.store);if(!r||y(r[d]))return null;const n=g(r);return"object"===r[f]&&t?.key?.length?a(n,t.key):n}async removeItem(e,t=""){if(t?.length){const r=await this.getItem(e)||{};return u(r,t),await this.setItem(e,r)}return await function(e,t=I()){return t("readwrite",(t=>(t.delete(e),w(t.transaction))))}(e,this.store)}async key(e){return(await v(this.store))[e]}get length(){return(async()=>(await v(this.store)).length)()}async clear(){return await function(e=I()){return e("readwrite",(e=>(e.clear(),w(e.transaction))))}(this.store)}},Object.defineProperty(e,"__esModule",{value:!0})}));//# sourceMappingURL=web-porridge.umd.js.map
