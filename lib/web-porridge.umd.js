!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WebPorridge={})}(this,(function(e){"use strict";const t=e=>{const t=typeof e;return null!==e&&("object"===t||"function"===t)},r=new Set(["__proto__","prototype","constructor"]),n=new Set("0123456789");function i(e){const t=[];let i="",s="start",o=!1;for(const a of e)switch(a){case"\\":if("index"===s)throw new Error("Invalid character in an index");if("indexEnd"===s)throw new Error("Invalid character after an index");o&&(i+=a),s="property",o=!o;break;case".":if("index"===s)throw new Error("Invalid character in an index");if("indexEnd"===s){s="property";break}if(o){o=!1,i+=a;break}if(r.has(i))return[];t.push(i),i="",s="property";break;case"[":if("index"===s)throw new Error("Invalid character in an index");if("indexEnd"===s){s="index";break}if(o){o=!1,i+=a;break}if("property"===s){if(r.has(i))return[];t.push(i),i=""}s="index";break;case"]":if("index"===s){t.push(Number.parseInt(i,10)),i="",s="indexEnd";break}if("indexEnd"===s)throw new Error("Invalid character after an index");default:if("index"===s&&!n.has(a))throw new Error("Invalid character in an index");if("indexEnd"===s)throw new Error("Invalid character after an index");"start"===s&&(s="property"),o&&(o=!1,i+="\\"),i+=a}switch(o&&(i+="\\"),s){case"property":if(r.has(i))return[];t.push(i);break;case"index":throw new Error("Index was not closed");case"start":t.push("")}return t}function s(e,t){if("number"!=typeof t&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function o(e,t){if(s(e,t))throw new Error("Cannot use string index")}function a(e,r,n){if(!t(e)||"string"!=typeof r)return void 0===n?e:n;const o=i(r);if(0===o.length)return n;for(let t=0;t<o.length;t++){const r=o[t];if(null==(e=s(e,r)?t===o.length-1?void 0:null:e[r])){if(t!==o.length-1)return n;break}}return void 0===e?n:e}function u(e,r,n){if(!t(e)||"string"!=typeof r)return e;const s=e,a=i(r);for(let r=0;r<a.length;r++){const i=a[r];o(e,i),r===a.length-1?e[i]=n:t(e[i])||(e[i]="number"==typeof a[r+1]?[]:{}),e=e[i]}return s}function c(e,r){if(!t(e)||"string"!=typeof r)return!1;const n=i(r);for(let r=0;r<n.length;r++){const i=n[r];if(o(e,i),r===n.length-1)return delete e[i],!0;if(e=e[i],!t(e))return!1}}const l="@value",d="@type",h="@expires";function f(e){return"bigint"==typeof e?e.toString():e}function g(e){const t=e[l];switch(e[d]){case"string":return t.toString();case"bigint":return BigInt(t);default:return t}}function y(e){switch(Object.prototype.toString.call(e)){case"[object Array]":case"[object Object]":return"object";case"[object BigInt]":return"bigint";case"[object Boolean]":return"boolean";case"[object Null]":return"null";case"[object Number]":return"number";case"[object String]":return"string";case"[object Undefined]":return"undefined"}}function p(e){return e&&new Date(e)<=new Date}function b(e,t){try{window.dispatchEvent(new CustomEvent(e,{detail:t}))}catch(e){}}function w(e,t,r){window.addEventListener(e,(e=>{e.detail.key===t&&r(e.detail.value)}))}const m="web-porridge:storage.didChange",v=["localStorage","sessionStorage"];function I(e){return new Promise(((t,r)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>r(e.error)}))}function x(e,t){const r=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(e){var t=function(){return indexedDB.databases().finally(e)};n=setInterval(t,100),t()})).finally((function(){return clearInterval(n)})):Promise.resolve()).then((()=>{const r=indexedDB.open(e);return r.onupgradeneeded=()=>r.result.createObjectStore(t),I(r)}));var n;return(e,n)=>r.then((r=>n(r.transaction(t,e).objectStore(t))))}let k;function j(){return k||(k=x("keyval-store","keyval")),k}function E(e=j()){return e("readonly",(e=>{if(e.getAllKeys)return I(e.getAllKeys());const t=[];return function(e,t){return e.openCursor().onsuccess=function(){this.result&&(t(this.result),this.result.continue())},I(e.transaction)}(e,(e=>t.push(e.key))).then((()=>t))}))}const S="web-porridge:db.didChange";e.WebPorridge=class{type;constructor(e="localStorage"){if("undefined"!=typeof window&&!(e in window))throw Error(`Your browser does not support ${e}`);if(!v.includes(e))throw`Invalid storage type specified, try ${v.join("|")} instead`;this.type=e}setItem(e,t,r){if(r?.key?.length){const n=this.getItem(e)||{};return u(n,r.key,t),this.setItem(e,n,{...r,key:void 0})}const n={[l]:f(t),[d]:y(t)};return r?.expires&&String(r.expires).length&&(n[h]=new Date(r.expires)),b(m,{key:e,value:t}),globalThis[this.type].setItem(e,JSON.stringify(n))}getItem(e,t){const r=JSON.parse(globalThis[this.type].getItem(e));if(!r||p(r[h]))return null;const n=g(r);return"object"===r[d]&&t?.key?.length?a(n,t.key):n}removeItem(e,t=""){if(t?.length){const r=this.getItem(e)||{};return c(r,t),this.setItem(e,r)}return b(m,{key:e,value:null}),globalThis[this.type].removeItem(e)}key(e){return globalThis[this.type].key(e)}get length(){return globalThis[this.type].length}clear(){return globalThis[this.type].clear()}hasItem(e){return Object.keys(globalThis[this.type]).includes(e)}keys(){return Object.keys(globalThis[this.type])}values(){return Object.keys(globalThis[this.type]).map((e=>this.getItem(e)))}entries(){return Object.keys(globalThis[this.type]).map((e=>[e,this.getItem(e)]))}observe(e,t){w(m,e,t)}},e.WebPorridgeDB=class{store;constructor(e){if("undefined"!=typeof window&&!("indexedDB"in window))throw Error("Your browser does not support IndexedDB");const{db:t,name:r}={db:"WebPorridge",name:"(default store)",...e};this.store=x(t,r)}async setItem(e,t,r={}){if(r?.key?.length){const n=await this.getItem(e)||{};return u(n,r.key,t),await this.setItem(e,n,{...r,key:void 0})}const n={[l]:f(t),[d]:y(t)};return r?.expires&&String(r.expires).length&&(n[h]=new Date(r.expires)),b(S,{key:e,value:t}),await function(e,t,r=j()){return r("readwrite",(r=>(r.put(t,e),I(r.transaction))))}(e,n,this.store)}async getItem(e,t){const r=await function(e,t=j()){return t("readonly",(t=>I(t.get(e))))}(e,this.store);if(!r||p(r[h]))return null;const n=g(r);return"object"===r[d]&&t?.key?.length?a(n,t.key):n}async removeItem(e,t=""){if(t?.length){const r=await this.getItem(e)||{};return c(r,t),await this.setItem(e,r)}return b(S,{key:e,value:null}),await function(e,t=j()){return t("readwrite",(t=>(t.delete(e),I(t.transaction))))}(e,this.store)}async key(e){return(await E(this.store))[e]}get length(){return(async()=>(await E(this.store)).length)()}async clear(){return await function(e=j()){return e("readwrite",(e=>(e.clear(),I(e.transaction))))}(this.store)}async hasItem(e){return(await E(this.store)).includes(e)}async keys(){return await E(this.store)}async values(){return Promise.all((await E(this.store)).map((async e=>await this.getItem(e))))}async entries(){return Promise.all((await E(this.store)).map((async e=>[e,await this.getItem(e)])))}observe(e,t){w(S,e,t)}},Object.defineProperty(e,"__esModule",{value:!0})}));//# sourceMappingURL=web-porridge.umd.js.map
