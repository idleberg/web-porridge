const e=e=>{const t=typeof e;return null!==e&&("object"===t||"function"===t)},t=new Set(["__proto__","prototype","constructor"]),r=new Set("0123456789");function n(e){const n=[];let i="",s="start",o=!1;for(const a of e)switch(a){case"\\":if("index"===s)throw new Error("Invalid character in an index");if("indexEnd"===s)throw new Error("Invalid character after an index");o&&(i+=a),s="property",o=!o;break;case".":if("index"===s)throw new Error("Invalid character in an index");if("indexEnd"===s){s="property";break}if(o){o=!1,i+=a;break}if(t.has(i))return[];n.push(i),i="",s="property";break;case"[":if("index"===s)throw new Error("Invalid character in an index");if("indexEnd"===s){s="index";break}if(o){o=!1,i+=a;break}if("property"===s){if(t.has(i))return[];n.push(i),i=""}s="index";break;case"]":if("index"===s){n.push(Number.parseInt(i,10)),i="",s="indexEnd";break}if("indexEnd"===s)throw new Error("Invalid character after an index");default:if("index"===s&&!r.has(a))throw new Error("Invalid character in an index");if("indexEnd"===s)throw new Error("Invalid character after an index");"start"===s&&(s="property"),o&&(o=!1,i+="\\"),i+=a}switch(o&&(i+="\\"),s){case"property":if(t.has(i))return[];n.push(i);break;case"index":throw new Error("Index was not closed");case"start":n.push("")}return n}function i(e,t){if("number"!=typeof t&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function s(e,t){if(i(e,t))throw new Error("Cannot use string index")}function o(t,r,s){if(!e(t)||"string"!=typeof r)return void 0===s?t:s;const o=n(r);if(0===o.length)return s;for(let e=0;e<o.length;e++){const r=o[e];if(null==(t=i(t,r)?e===o.length-1?void 0:null:t[r])){if(e!==o.length-1)return s;break}}return void 0===t?s:t}function a(t,r,i){if(!e(t)||"string"!=typeof r)return t;const o=t,a=n(r);for(let r=0;r<a.length;r++){const n=a[r];s(t,n),r===a.length-1?t[n]=i:e(t[n])||(t[n]="number"==typeof a[r+1]?[]:{}),t=t[n]}return o}function c(t,r){if(!e(t)||"string"!=typeof r)return!1;const i=n(r);for(let r=0;r<i.length;r++){const n=i[r];if(s(t,n),r===i.length-1)return delete t[n],!0;if(t=t[n],!e(t))return!1}}const u="@value",l="@type",h="@expires";function d(e){return"bigint"==typeof e?e.toString():e}function f(e){const t=e[u];switch(e[l]){case"string":return t.toString();case"bigint":return BigInt(t);default:return t}}function g(e){switch(Object.prototype.toString.call(e)){case"[object Array]":case"[object Object]":return"object";case"[object BigInt]":return"bigint";case"[object Boolean]":return"boolean";case"[object Null]":return"null";case"[object Number]":return"number";case"[object String]":return"string";case"[object Undefined]":return"undefined"}}function y(e){return e&&new Date(e)<=new Date}function p(e,t){try{window.dispatchEvent(new CustomEvent(e,{detail:t}))}catch(e){}}function w(e,t,r){window.addEventListener(e,(e=>{e.detail.key===t&&r(e.detail.value)}))}const b="web-porridge:storage.didChange",m=["localStorage","sessionStorage"];class I{type;constructor(e="localStorage"){if("undefined"!=typeof window&&!(e in window))throw Error(`Your browser does not support ${e}`);if(!m.includes(e))throw`Invalid storage type specified, try ${m.join("|")} instead`;this.type=e}setItem(e,t,r){if(r?.key?.length){const n=this.getItem(e)||{};return a(n,r.key,t),this.setItem(e,n,{...r,key:void 0})}const n={[u]:d(t),[l]:g(t)};return r?.expires&&String(r.expires).length&&(n[h]=new Date(r.expires)),p(b,{key:e,value:t}),globalThis[this.type].setItem(e,JSON.stringify(n))}getItem(e,t){const r=JSON.parse(globalThis[this.type].getItem(e));if(!r||y(r[h]))return null;const n=f(r);return"object"===r[l]&&t?.key?.length?o(n,t.key):n}removeItem(e,t=""){if(t?.length){const r=this.getItem(e)||{};return c(r,t),this.setItem(e,r)}return p(b,{key:e,value:null}),globalThis[this.type].removeItem(e)}key(e){return globalThis[this.type].key(e)}get length(){return globalThis[this.type].length}clear(){return globalThis[this.type].clear()}hasItem(e){return Object.keys(globalThis[this.type]).includes(e)}keys(){return Object.keys(globalThis[this.type])}values(){return Object.keys(globalThis[this.type]).map((e=>this.getItem(e)))}entries(){return Object.keys(globalThis[this.type]).map((e=>[e,this.getItem(e)]))}observe(e,t){w(b,e,t)}}function v(e){return new Promise(((t,r)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>r(e.error)}))}function k(e,t){const r=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(e){var t=function(){return indexedDB.databases().finally(e)};n=setInterval(t,100),t()})).finally((function(){return clearInterval(n)})):Promise.resolve()).then((()=>{const r=indexedDB.open(e);return r.onupgradeneeded=()=>r.result.createObjectStore(t),v(r)}));var n;return(e,n)=>r.then((r=>n(r.transaction(t,e).objectStore(t))))}let x;function j(){return x||(x=k("keyval-store","keyval")),x}function E(e=j()){return e("readonly",(e=>{if(e.getAllKeys)return v(e.getAllKeys());const t=[];return function(e,t){return e.openCursor().onsuccess=function(){this.result&&(t(this.result),this.result.continue())},v(e.transaction)}(e,(e=>t.push(e.key))).then((()=>t))}))}const S="web-porridge:db.didChange";class D{store;constructor(e){if("undefined"!=typeof window&&!("indexedDB"in window))throw Error("Your browser does not support IndexedDB");const{db:t,name:r}={db:"WebPorridge",name:"(default store)",...e};this.store=k(t,r)}async setItem(e,t,r={}){if(r?.key?.length){const n=await this.getItem(e)||{};return a(n,r.key,t),await this.setItem(e,n,{...r,key:void 0})}const n={[u]:d(t),[l]:g(t)};return r?.expires&&String(r.expires).length&&(n[h]=new Date(r.expires)),p(S,{key:e,value:t}),await function(e,t,r=j()){return r("readwrite",(r=>(r.put(t,e),v(r.transaction))))}(e,n,this.store)}async getItem(e,t){const r=await function(e,t=j()){return t("readonly",(t=>v(t.get(e))))}(e,this.store);if(!r||y(r[h]))return null;const n=f(r);return"object"===r[l]&&t?.key?.length?o(n,t.key):n}async removeItem(e,t=""){if(t?.length){const r=await this.getItem(e)||{};return c(r,t),await this.setItem(e,r)}return p(S,{key:e,value:null}),await function(e,t=j()){return t("readwrite",(t=>(t.delete(e),v(t.transaction))))}(e,this.store)}async key(e){return(await E(this.store))[e]}get length(){return(async()=>(await E(this.store)).length)()}async clear(){return await function(e=j()){return e("readwrite",(e=>(e.clear(),v(e.transaction))))}(this.store)}async hasItem(e){return(await E(this.store)).includes(e)}async keys(){return await E(this.store)}async values(){return Promise.all((await E(this.store)).map((async e=>await this.getItem(e))))}async entries(){return Promise.all((await E(this.store)).map((async e=>[e,await this.getItem(e)])))}observe(e,t){w(S,e,t)}}export{I as WebPorridge,D as WebPorridgeDB};//# sourceMappingURL=web-porridge.esm.js.map
