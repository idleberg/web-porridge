const e=e=>{const t=typeof e;return null!==e&&("object"===t||"function"===t)},t=new Set(["__proto__","prototype","constructor"]),r=new Set("0123456789");function n(e){const n=[];let i="",o="start",s=!1;for(const a of e)switch(a){case"\\":if("index"===o)throw new Error("Invalid character in an index");if("indexEnd"===o)throw new Error("Invalid character after an index");s&&(i+=a),o="property",s=!s;break;case".":if("index"===o)throw new Error("Invalid character in an index");if("indexEnd"===o){o="property";break}if(s){s=!1,i+=a;break}if(t.has(i))return[];n.push(i),i="",o="property";break;case"[":if("index"===o)throw new Error("Invalid character in an index");if("indexEnd"===o){o="index";break}if(s){s=!1,i+=a;break}if("property"===o){if(t.has(i))return[];n.push(i),i=""}o="index";break;case"]":if("index"===o){n.push(Number.parseInt(i,10)),i="",o="indexEnd";break}if("indexEnd"===o)throw new Error("Invalid character after an index");default:if("index"===o&&!r.has(a))throw new Error("Invalid character in an index");if("indexEnd"===o)throw new Error("Invalid character after an index");"start"===o&&(o="property"),s&&(s=!1,i+="\\"),i+=a}switch(s&&(i+="\\"),o){case"property":if(t.has(i))return[];n.push(i);break;case"index":throw new Error("Index was not closed");case"start":n.push("")}return n}function i(e,t){if("number"!=typeof t&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function o(e,t){if(i(e,t))throw new Error("Cannot use string index")}function s(t,r,o){if(!e(t)||"string"!=typeof r)return void 0===o?t:o;const s=n(r);if(0===s.length)return o;for(let e=0;e<s.length;e++){const r=s[e];if(null==(t=i(t,r)?e===s.length-1?void 0:null:t[r])){if(e!==s.length-1)return o;break}}return void 0===t?o:t}function a(t,r,i){if(!e(t)||"string"!=typeof r)return t;const s=t,a=n(r);for(let r=0;r<a.length;r++){const n=a[r];o(t,n),r===a.length-1?t[n]=i:e(t[n])||(t[n]="number"==typeof a[r+1]?[]:{}),t=t[n]}return s}function c(t,r){if(!e(t)||"string"!=typeof r)return!1;const i=n(r);for(let r=0;r<i.length;r++){const n=i[r];if(o(t,n),r===i.length-1)return delete t[n],!0;if(t=t[n],!e(t))return!1}}const u="@value",l="@type",f="@expires";function d(e){return"bigint"==typeof e?e.toString():e}function h(e){const t=e[u];switch(e[l]){case"string":return t.toString();case"bigint":return BigInt(t);default:return t}}function g(e){switch(Object.prototype.toString.call(e)){case"[object Array]":case"[object Object]":return"object";case"[object BigInt]":return"bigint";case"[object Boolean]":return"boolean";case"[objectNull]":return"null";case"[object Number]":return"number";case"[object String]":return"string";case"[object Undefined]":return"undefined"}}function p(e){return e&&new Date(e)<=new Date}const y=["localStorage","sessionStorage"];class w{type;constructor(e="localStorage"){if("undefined"!=typeof window&&!(e in window))throw Error(`Your browser does not support ${e}`);if(!y.includes(e))throw`Invalid storage type specified, try ${y.join("|")} instead`;this.type=e}setItem(e,t,r){if(r?.key?.length){const n=this.getItem(e)||{};return a(n,r.key,t),this.setItem(e,n,{...r,key:void 0})}const n={[u]:d(t),[l]:g(t)};return r?.expires&&String(r.expires).length&&(n[f]=new Date(r.expires)),globalThis[this.type].setItem(e,JSON.stringify(n))}getItem(e,t){const r=JSON.parse(globalThis[this.type].getItem(e));if(!r||p(r[f]))return null;const n=h(r);return"object"===r[l]&&t?.key?.length?s(n,t.key):n}removeItem(e,t=""){if(t?.length){const r=this.getItem(e)||{};return c(r,t),this.setItem(e,r)}return globalThis[this.type].removeItem(e)}key(e){return globalThis[this.type].key(e)}get length(){return globalThis[this.type].length}clear(){return globalThis[this.type].clear()}}function b(e){return new Promise(((t,r)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>r(e.error)}))}function x(e,t){const r=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(e){var t=function(){return indexedDB.databases().finally(e)};n=setInterval(t,100),t()})).finally((function(){return clearInterval(n)})):Promise.resolve()).then((()=>{const r=indexedDB.open(e);return r.onupgradeneeded=()=>r.result.createObjectStore(t),b(r)}));var n;return(e,n)=>r.then((r=>n(r.transaction(t,e).objectStore(t))))}let m;function I(){return m||(m=x("keyval-store","keyval")),m}function v(e=I()){return e("readonly",(e=>{if(e.getAllKeys)return b(e.getAllKeys());const t=[];return function(e,t){return e.openCursor().onsuccess=function(){this.result&&(t(this.result),this.result.continue())},b(e.transaction)}(e,(e=>t.push(e.key))).then((()=>t))}))}class k{store;constructor(e){if("undefined"!=typeof window&&!("indexedDB"in window))throw Error("Your browser does not support IndexedDB");const{db:t,name:r}={db:"WebPorridge",name:"(default store)",...e};this.store=x(t,r)}async setItem(e,t,r={}){if(r?.key?.length){const n=await this.getItem(e)||{};return a(n,r.key,t),await this.setItem(e,n,{...r,key:void 0})}const n={[u]:d(t),[l]:g(t)};return r?.expires&&String(r.expires).length&&(n[f]=new Date(r.expires)),await function(e,t,r=I()){return r("readwrite",(r=>(r.put(t,e),b(r.transaction))))}(e,n,this.store)}async getItem(e,t){const r=await function(e,t=I()){return t("readonly",(t=>b(t.get(e))))}(e,this.store);if(!r||p(r[f]))return null;const n=h(r);return"object"===r[l]&&t?.key?.length?s(n,t.key):n}async removeItem(e,t=""){if(t?.length){const r=await this.getItem(e)||{};return c(r,t),await this.setItem(e,r)}return await function(e,t=I()){return t("readwrite",(t=>(t.delete(e),b(t.transaction))))}(e,this.store)}async key(e){return(await v(this.store))[e]}get length(){return(async()=>(await v(this.store)).length)()}async clear(){return await function(e=I()){return e("readwrite",(e=>(e.clear(),b(e.transaction))))}(this.store)}}export{w as WebPorridge,k as WebPorridgeDB};//# sourceMappingURL=web-porridge.esm.js.map
